module.exports=function(f){var g=require("esperanto");var n=require("path");var i=require("es6-promise").Promise;var a="build/tmp";function m(p){var q=[],o=[];p.split("\n").forEach(function(r){if(r.trim().slice(0,3)==="//!"){q.push(r.trim())}else{o.push(r)}});return q.concat([""],o).join("\n")}var l={};function c(o){if(!(o in l)){l[o]=f.file.read(o)}return l[o]}function j(o){var q=o.headerFile?"not_used":o.umdName,r=o.headerFile?c(o.headerFile):"",p=o.skipLines?o.skipLines:0;return g.bundle({base:o.base,entry:o.entry,skip:o.skip||[]}).then(function(t){var s=t.toUmd({name:q}),u=r+s.code.split("\n").slice(p).join("\n");if(o.moveComments){u=m(u)}f.file.write(o.target,u)})}function e(s){var q=50,t=i.resolve(null),r=f.file.expand({cwd:s.base},s.pattern),p,o=function(u){t=t.then(function(){return i.all(r.slice(u,u+q).map(function(v){return j({base:s.base,entry:v,headerFile:s.headerFile,skip:s.skip,skipLines:s.skipLines,moveComments:s.moveComments,target:n.join(s.targetDir,v)})}))})};for(p=0;p<r.length;p+=q){o(p)}return t}function b(q){var p=f.file.expand({cwd:q},"**/*.js"),o=a;if(f.file.exists(o)){return}p.forEach(function(r){f.file.copy(n.join(q,r),n.join(o,r))})}function d(p){var o=p.entry||n.basename(p.target);b(p.base);f.file.write(n.join(a,o),p.code);return j({base:a,entry:o,umdName:p.umdName||"not_used",headerFile:p.headerFile,skipLines:p.skipLines,moveComments:p.moveComments,target:p.target,skip:p.skip})}function h(r,o){var q=o,p=q.map(function(t){var s=n.basename(t,".js").replace("-","_");return"import "+s+' from "./'+t+'";'}).join("\n");return d({base:"src",code:p,target:r,skip:["moment"],headerFile:"templates/locale-header.js",skipLines:5})}function k(s,p){var r=p,o=r.map(function(v){var u=n.basename(v,".js").replace("-","_");var t=v.replace(".js","");return"import "+u+' from "./'+t+'";'}).join("\n"),q='import * as moment_export from "./moment";\n\n'+o+"\n\nexport default moment_export;";return d({base:"src",code:q,umdName:"moment",target:s}).then(function(){var u=f.file.read(s);var t=new RegExp("var ([a-z$_]+) =\\s+{[^]\\s+get default \\(\\) { return ([a-z$_]+); }[^]\\s+}","");var v=u.match(t);if(v.length!==3){f.file.write("/tmp/crap.js",u);throw new Error("Failed to detect get default crap, check /tmp/crap.js")}u=u.replace(t,"");u=u.replace("var moment_with_locales = "+v[1],"var moment_with_locales = "+v[2]);if(u.match("get default")){f.file.write("/tmp/crap.js",u);throw new Error("Stupid shit es6 get default plaguing the code, check /tmp/crap.js")}f.file.write(s,u)})}f.task.registerTask("transpile-raw","convert es6 to umd",function(){var o=this.async();j({base:"src",entry:"moment.js",umdName:"moment",target:"build/umd/moment.js",moveComments:true}).then(function(){f.log.ok("build/umd/moment.js")}).then(function(){return e({base:"src",pattern:"locale/*.js",headerFile:"templates/locale-header.js",skipLines:5,moveComments:true,targetDir:"build/umd",skip:["moment"]})}).then(function(){f.log.ok("build/umd/locale/*.js")}).then(function(){return e({base:"src",pattern:"test/moment/*.js",headerFile:"templates/test-header.js",skipLines:5,moveComments:true,targetDir:"build/umd",skip:["moment"]})}).then(function(){f.log.ok("build/umd/test/moment/*.js")}).then(function(){return e({base:"src",pattern:"test/locale/*.js",headerFile:"templates/test-header.js",skipLines:5,moveComments:true,targetDir:"build/umd",skip:["moment"]})}).then(function(){f.log.ok("build/umd/test/locale/*.js")}).then(function(){return h("build/umd/min/locales.js",f.file.expand({cwd:"src"},"locale/*.js"))}).then(function(){f.log.ok("build/umd/min/locales.js")}).then(function(){return k("build/umd/min/moment-with-locales.js",f.file.expand({cwd:"src"},"locale/*.js"))}).then(function(){f.log.ok("build/umd/min/moment-with-locales.js")}).then(o,function(p){f.log.error("error transpiling",p);o(p)})});f.task.registerTask("transpile-custom-raw","build just custom language bundles",function(o){var p=this.async();var q=o.split(",").map(function(r){var s=f.file.expand({cwd:"src"},"locale/"+r+".js");if(s.length!==1){p(new Error("could not find locale: "+r));p=null}else{return s[0]}});if(p==null){return}return h("build/umd/min/locales.custom.js",q).then(function(){f.log.ok("build/umd/min/locales.custom.js")}).then(function(){return k("build/umd/min/moment-with-locales.custom.js",q)}).then(function(){f.log.ok("build/umd/min/moment-with-locales.custom.js")}).then(p,function(r){f.log.error("error transpiling-custom",r);p(r)})});f.config("clean.build",["build"]);f.config("concat.tests",{src:"build/umd/test/**/*.js",dest:"build/umd/min/tests.js"});f.task.registerTask("transpile","builds all es5 files, optinally creating custom locales",function(o){var p=["clean:build","transpile-raw","concat:tests"];if(o){p.push("transpile-custom-raw:"+o)}f.task.run(p)})};